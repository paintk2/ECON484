---
title: "Real Estate Analysis"
author: "Group 4"
date: '2022-05-20'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
library(tidyverse)
```

```{r accesory}
accessory <- read.csv("./data/EXTR_Accessory_V.csv")

accessory <- accessory %>% 
  mutate(mm_key = paste0(Major, '-', Minor), .before = 1) %>% 
  select(-c(Major, Minor, AccyDescr, UpdatedBy, UpdateDate))

accessory <- accessory %>% 
  filter(Size >= 0)

accessory$AccyType <- as.factor(accessory$AccyType)
```

```{r sales}
# Data Wrangling 
raw_sales <- read.csv("./data/EXTR_RPSale.csv")

#change document date to year/date format 
# remove non-residential buildings
sales_clean <- raw_sales %>% 
  filter(PropertyType %in% c(10, 11, 12, 13, 14, 18, 19, 2, 3, 6)) %>% 
  # mutate(DocumentDate = as.numeric(substr(DocumentDate, 7, 10))) 
  mutate(DocumentDate = as.Date(DocumentDate, format = c("%m/%d/%Y")))


sales <- sales_clean %>% 
  filter(DocumentDate >= "2012-01-01")
  

  # not including mobile homes, check 6 

# Combines Major and Minor columns
combineID <- function(df) {
  df %>% 
    mutate(mm_key = paste0(Major, '-', Minor), .before = 1) %>% 
    select(-c(Major, Minor))
}
sales <- combineID(sales)
# test <- sales %>% filter(str_detect(AFForestLand, 'Y'))

# removing useless information
sales <- sales %>%
  select(c(mm_key, DocumentDate, SalePrice, PropertyType, PrincipalUse, SaleInstrument, AFForestLand, AFCurrentUseLand, AFNonProfitUse, AFHistoricProperty, SaleReason, PropertyClass))
sales$PropertyType <- as.factor(sales$PropertyType)
sales$PrincipalUse <- as.factor(sales$PrincipalUse)
sales$SaleInstrument <- as.factor(sales$SaleInstrument)
sales$SaleReason <- as.factor(sales$SaleReason)
sales$PropertyClass <- as.factor(sales$PropertyClass)
str(sales)
```

```{r permits}
# clean EXTR_HomeImpExempts.csv
# combine major and minor key
# delete columns BldgNbr, FirstBillYr, LastBillYr, ValuedBy, UpdatedBy, UpdateDate
# remove rows with 0 improvement value
# factor data

homeexe <- read.csv('EXTR_HomeImpExempts.csv')

homeexe <- homeexe %>%
  mutate(mm_key = paste0(Major, '-', Minor), ValueDate = substr(ValueDate, 1, 4), .before = 1) %>%
  select(-c(Major, Minor, BldgNbr, FirstBillYr, LastBillYr, ValuedBy, UpdatedBy, UpdateDate))

# filter those with an actual improvement value
homeexe <- homeexe %>%
  filter(HomeImpVal > 0)

# factor the data
homeexe$HIExemptId = as.factor(homeexe$HIExemptId)
homeexe$NoteId = as.factor(homeexe$NoteId)
```

```{r valuehist}
# clean EXTR_ValueHistory_V.csv
# combine major and minor
# factor data

valhist <- read.csv('EXTR_ValueHistory_V.csv')

valhist <- valhist %>%
  mutate(mm_key = paste0(Major, '-', Minor), .before = 1) %>%
  select(-c(Major, Minor, OmitYr, ApprLandVal, ApprImpsVal, ApprImpIncr, TaxValReason, TaxStatus, ChangeDate, ChangeDocId, Reason, SplitCode))

# filter those that are prior to 2012
valhist <- valhist %>%
  filter(TaxYr > 2012)

# factor data
valhist$LevyCode = as.factor(valhist$LevyCode)
```

```{r residential}
resBldg <- read.csv("./data/EXTR_ResBldg.csv")
resBldg <- combineID(resBldg)

# removing useless
# resBldg <- resBldg %>%
#   select( -c(Address, BuildingNumber, Fraction, DirectionPrefix, StreetName, StreetType, DirectionSuffix, ))
# str(res)
```

```{r merge}
df <- sales_2012 %>%
  left_join(accessory, by="mm_key") %>%
  left_join(homeexe, by="mm_key") %>%
  left_join(valhist, by="mm_key") %>%
  left_join(resBldg, by="mm_key")
  
```



